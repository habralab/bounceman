Сборщик почтовых отлупов (bounces)
==================================

Сборщик предназначен для сборки почтовых отлупов от MTA Exim с целью анализа несуществующих/невалидных почтовых адресов получателей.

Анализирует заголовки exim и строит таблицу с полями:

* Дата и время письма (`Delivery-Date` заголовок)
* Адрес отправителя (`Envelope-To` заголовок)
* Адрес получателя (`X-Failed-Recipients` заголовок)
* Описание ошибки (как его формирует сервер получателя)


Системные требования
--------------------

* MariaDB 10.6+ или MySQL 5.7+
* PHP 8.1+ (с расширениями `imap` и `pdo_mysql`)
* любой HTTP-сервер с поддержкой PHP
* IMAP-сервер с ящиком для сборки bounces формата Exim4


Сборка программы
----------------

Для сборки запустите `make`, на выходе получите файл `bounceman.phar` он является как программой для консоли, так и web-приложением.


Типичный сценарий использования
-------------------------------

Необходимо использовать реальный доступный по IMAP почтовый ящик для сборки отчётов о недоставке (баунсы или сообщения от Mailer Daemon). Софт рассылки должен быть настроен на использование адреса этого ящика в качестве `Return-Path`.

* Первичная инициализация базы данных командой `init`
* Добавление ящиков командой `new`
* Включение ящиков командой `enable`
* Добавление в crontab команды `collect`
* Использование команд `check` и `dump` или HTTP-API


Консольные команды
------------------

Консольные команды запускаются так: `php bounceman.phar COMMAND`.

Опции `--since` и `--until` принимают дату/время в формате, описанном [тут](https://www.php.net/manual/en/datetime.formats.php).

```
init	- инициализация базы данных, запустите перед началом использования  

new		- добавление почтового ящика для сбора писем  

edit	- редактирование почтового ящика  

list	- вывод списка почтовых ящиков  

collect	- сбор писем со всех включённых ящиков  

enable MBOX	- включение ящика с именем MBOX  

disable MBOX	- отключение ящика с именем MBOX  

test MBOX		- проверка IMAP-соединения с ящиком с именем MBOX  

check [OPTIONS] [EMAIL]...	- поиск почтового адреса в списке недоставленных писем  
	OPTIONS:
		--since	- дата/время начала временного интервала для поиска
		--until	- дата/время окончания временного интервала для поиска
		--mbox		- имя ящика, в котором следует искать,
					опция может повторяться для задания нескольких ящиков;
					по умолчанию поиск проводится во всех ящиках
	EMAIL -	искомый почтовый адрес, можно задать несколько

dump [OPTIONS] [MBOX]...	- вывод всех почтовых адресов из списка недоставленных писем
	OPTIONS:
		--since -	дата/время начала временного интервала для поиска
		--until -	дата/время окончания временного интервала для поиска
	MBOX	- имя ящика, в котором следует искать,
			можно задать несколько;
			по умолчанию поиск проводится во всех ящиках
```


WEB-интерфейс
-------------

Для запуска web-интерфейса вам потребуется любой http-сервер с поддержкой PHP.

Пример запуска сервера, встроенного в PHP: `php -S 127.0.0.1:8080 bounceman.phar`, после этого web-интерфейс будет доступен по адресу `http://localhost:8080/`.

Рекомендуется использовать PHP-FPM сервер для работы с этим приложением. Пример конфигурации для Nginx (с PHP-FPM):

```
server {
    listen 80;
    server_name bounceman.local;

    location / {
        fastcgi_pass unix:/path/to/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME /path/to/bounceman.phar;
        include fastcgi_params;
    }
}
```


HTTP-API
--------

Помимо web-интерфейса доступно HTTP API. Все параметры передаются методом `GET`. Параметры `since` и `until` аналогичны опциям `--since` и `--until` для консольных команд.

```
/check - поиск почтового адреса в списке недоставленных писем
	Параметры:
		since		- дата/время начала временного интервала для поиска
		until		- дата/время окончания временного интервала для поиска
		mboxes[]	- имена ящиков, в которых следует искать;
					по умолчанию поиск проводится во всех ящиках
		emails[]	- искомые почтовые адреса
	Ответ в формате JSON:
		Массив объектов с полями:
			email		- искомый адрес
			status		- OK (не найден) или ERROR (найден)
			mbox		- ящик, в котором найден адрес 
			date		- дата последнего недоставленного письма
			error		- текст ошибки последнего недоставленнго письма
/dump - вывод всех почтовых адресов из списка недоставленных писем
	Options:
		since		- дата/время начала временного интервала для поиска
		until		- дата/время окончания временного интервала для поиска
		mboxes[]	- имена ящиков, в которых следует искать;
					по умолчанию поиск проводится во всех ящиках
	Ответ в текстовом формате:
		Каждая строка содержит один почтовый адрес, для которого есть недоставленное письмо
```
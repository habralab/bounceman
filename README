Сборщик почтовых отлупов (bounces)
==================================

Сборщик предназначен для сборки почтовых отлупов от MTA Exim с целью анализа несуществующих/невалидных почтовых адресов получателей.
Анализирует заголовки exim и строит таблицу с полями:
 * Дата и время письма (заголовок Delivery-Date)
 * Адрес отправителя (заголовок Envelope-To)
 * Адрес получателя (заголовок X-Failed-Recipients)
 * Описание ошибки (как его формирует сервер получателя)


Системные требования
--------------------

* MySQL 5.7+ или MariaDB 10.6+
* PHP 8.1+ (с расширениями imap и pdo_mysql)
* любой http-сервер с поддержкой PHP
* IMAP-сервер с ящиком для сборки bounces формата Exim4


Сборка программы
----------------

Для сборки запустите make, на выходе получите файл bounceman.phar, он является как программой для консоли, так и web-приложением.


Типичный сценарий использования
-------------------------------

* Инициализация командой init
* Добавление ящиков командой new
* Включение ящиков командой enable
* Добавление в crontab команды collect
* Использование команд check и dump или HTTP-API


Консольные команды
------------------

Консольные команды запускаются так "php bounceman.phar COMMAND". Опции --since и --until принимают дату/время в формате, описанном тут https://www.php.net/manual/en/datetime.formats.php

init - инициализация базы данных, запустите перед началом использования

new  - добавление почтового ящика для сбора писем

edit - редактирование почтового ящика

list - вывод списка почтовых ящиков

enable/disable MBOX - включение/отключение ящика с именем MBOX

test MBOX - проверка соединения с ящиком с именем MBOX

collect - сбор писем со всех включённых ящиков

check [OPTIONS] [EMAIL]... - поиск почтового адреса в списке отлупов
    OPTIONS:
        --since - дата/время начала временного интервала для поиска
        --until - дата/время окончания временного интервала для поиска
        --mbox  - имя ящика, в котором следует искать, опция может повторяться для задания нескольких ящиков;
                  по умолчанию поиск проводится во всех ящиках
    EMAIL - искомый почтовый адрес, можно задать несколько

dump [OPTIONS] [MBOX]... - вывод списка всех почтовых адресов в списке отлупов
    OPTIONS:
        --since - дата/время начала временного интервала для поиска
        --until - дата/время окончания временного интервала для поиска
    MBOX - имя ящика, в котором следует искать, можно задать несколько;
           по умолчанию поиск проводится во всех ящиках


WEB-интерфейс
-------------

Для запуска web-интерфейса вам потребуется любой http-сервер с поддержкой PHP.

Пример запуска сервера, встроенного в PHP: "php -S 127.0.0.1:8080 bounceman.phar", после этого web-интерфейс будет доступен по адресу http://127.0.0.1:8080/

Пример конфигурации для nginx+php-fpm:

server {
    listen 80;
    server_name bounceman.local;

    location / {
        fastcgi_pass unix:/path/to/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME /path/to/bounceman.phar;
        include fastcgi_params;
    }
}


HTTP-API
--------

Помимо web-интерфейса доступно HTTP-API. Все параметры передаются методом GET. Параметры since и until аналогичны опциям --since и --until для консольных команд.

/check - поиск почтового адреса в списке недоставленных писем
    Параметры:
        since    - дата/время начала временного интервала для поиска
        until    - дата/время окончания временного интервала для поиска
        mboxes[] - имена ящиков, в которых следует искать;
                   по умолчанию поиск проводится во всех ящиках
        emails[] - искомые почтовые адреса
    Ответ в формате JSON:
        Массив объектов с полями
            "email"  - искомый адрес
            "status" - "OK" (не найден) или "ERROR" (найден)
            "mbox"   - ящик, в котором найден адрес
            "date"   - дата последнего недоставленного письма
            "error"  - текст ошибки последнего недоставленнго письма

/dump - вывод всех почтовых адресов из списка недоставленных писем
    Параметры:
        since    - дата/время начала временного интервала для поиска
        until    - дата/время окончания временного интервала для поиска
        mboxes[] - имена ящиков, в которых следует искать;
                   по умолчанию поиск проводится во всех ящиках
    Ответ в текстовом формате:
        Каждая строка содержит один почтовый адрес, для которого есть недоставленное письмо
